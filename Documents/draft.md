---
title: "lilcaSoundDriverFC 仕様書"
author: "lilca reload(Masayuki Ise)"
date: "2025-12-08"
---

# 概要
- 対象：FC / NES 向けサウンドドライバ
- 環境：NTSC / PAL
- 記述言語：MML

## 設計方針

1. サウンドドライバを軽量&高速にする
2. 上記のために、MMLコンパイラに大部分の処理をする
3. 具体的には、マクロ展開、冗長部分の最適化をMMLコンパイラで行う
4. クォンタイズ廃止のため、チャンネル毎の長さの整合させるロジックを入れる

# 構成
```

 +-------+    +================+    +---------------------+
 | MML   | -> | lsdc(Compiler) | -> | asm インクルードファイル |
 +-------+    +================+    +---------------------+
                                                |
                                                V
      +***********+    +-----------+    +===============+    +---------------+
      | FC or NES | <- | nesファイル | <- | cc65 コマンド群　| <- | lSDFCライブラリ　|
      +***********+    +-----------+    +===============+    +---------------+
                                                ^
                                                |
                                         +--------------+
                                         | ユーザのコード 　|
                                         +--------------+

+---+ ソースファイル
+===+ 実行ファイル
+**** ハードウェア

```

# MML構造

- メタ情報
  - セマンティックデータ
  - インフォメーションデータ
- マクロ定義
  - マクロ一覧
  - 記述方法
  - パラメータ
- ステートメントマクロ
  - 記述方法
- チャンネルデータ
  - 記述方法
  - チャンネルシンボル
  - MMLステートメント
  - DPCM(未実装)
- コメント

# メタ情報

## セマンティックデータ
- 特定の情報と解釈され、プログラム上でデータとして取り出せる形で出力されます

### セマンティックデータ一覧
|項目|キーワード(大文字)|備考|
|:-:|:-:|:-|
|曲名|TITLE||
|作曲者|COMPOSER||
|プログラマ|PROGRAMER|MML化した人|
|ラベル|LABEL|プログラム上で使われるラベル名(mck mmlの仕様にはない)|

## インフォメーションデータ
- プログラムコード内のコメントとして出力されます

## 記述方法
```
 <"#"> <META_KEYWORD> <" ">+ <string>
```
- キーワード直後の区切り文字以降の文字列を前後トリミングした値となる

## 例
```
例:
 "#COMPOSER   lilca reload   "

 Meta Value = "lilca reload"
```

# マクロ定義

## マクロ一覧

|マクロ名|定義記号|使用記号|ループ指定|終端子|備考|
|:-|:-:|:-:|:-:|:-:|:-|
|ボリューム|@v[n]|@v1|あり(*)|-|フレーム単位で<br>ボリュームを変化させる|
|トーン(音色)|@[n]|@@0|あり(*2)|-|フレーム単位で<br>音色を変化させる|
|アルペジオ|@EN[n]|EN1|あり(*)|ENOF|フレーム単位で<br>音階を変化させる|
|ピッチ|@EP[n]|EP0|あり(*)|EPOF|フレーム単位で<br>指定方向と量で<br>音階を変化させる|
|ビブラート|@MP[n]|MP2|-|MPOF|指定された<br>周期と振幅のSin波で<br>音階を変化させる|
|DPCM割り当て|@DPCM[n]| c |-|-|n=0,1,2,3,4...<br>-> c,c+,d,d+,e...<br>に割り当て|

* "\|"以降をループする, "\|"がない場合は最後の値をループする
* 255フレームを超える音符は、マクロがリセットされてしまう暫定仕様あり

## 記述方法
```
<定義記号><数値> <"="> <"{"> <数値>+ [<"|"> <数値>] <"}">
```

### 例
```
 @v0={ 15 8 4 2 0}  ; 1フレーム目 15 ... 5フレーム目 0 それ以降 0
 @v1={ 15 |8 4 }    ; １フレーム目 15, 2フレーム目 8, 3フレーム目 4, それ以降 8と4を繰り返す
 @v2={|15 15 12 11 10 8 8 8 } ; '|' 以降の数値を繰り返す
 @EP0={2 |4 0}  ; 1フレーム目 +2, 2フレーム目 +6, 3フレーム目 +6, 以降 4,0増加させる (*)
 @EP1={-16}; 1フレーム目 変化なし, 2フレーム目 16減少, 3フレーム目 さらに16減少, 以降 16現状させる(*)
 @MP={4 31 128} ; 4フレーム変化なし,それ以降 31+1フレームを周期,振幅を(±M2)*(128/255)の三角波でピッチ変化させる
                ; つまり今回は上下におよそ半音変化するピッチ変化
```

## パラメータ

- ボリューム, トーン, アルペジオ, ピッチ共通

|値|範囲|説明|
|:-|:-|:-|
|ボリューム値|0~15||
|トーン|0~3|矩形波=duty比<br>ノイズ波=ノイズモード|
|相対音階|-127~126|cに対して<br>1 は c+<br>-1 は b|
|増減値|-127~126|矩形波と三角波 -> 11bitタイマー<br>ノイズ波 -> 4bitピリオド|

- ビブラート

|値|範囲|説明|
|:-|:-|:-|
|遅延|0~255|適用するまで変化させないフレーム数|
|速さ|1~255|ステップ数|
|深さ|0~255|振幅<br>矩形波と三角波 -> 11bitタイマー<br>ノイズ波 -> 4bitピリオド|

* ビブラートの周期 = 速さ * ( 深さ + 1 )
  
 
- DPCM

|値|範囲|説明|
|:-|:-|:-|
|ファイルパス|文字列|実行ディレクトリからの相対パス|
|パラメータ１|0~15|ピッチ 15=ノーマル (*)<br>$4010 b3-0のRate Index|
|パラメータ2|0~4081|再生するブロック数(16byte単位)<br>0または省略時=ファイルサイズ (*)|
|パラメータ3|0~15|出力レベル(波形のスタート地点) (*)<br>$FF 推奨<br>この値から波形が増減する|
|パラメータ4|0~2|再生モード (*)<br>0=1ショット, 1=ループ|

(* 後方省略可能だが、中間のパラメータは省略できない)


# ステートメントマクロ

## 記述方法

```
<"$"><名前> <MMLステートメント>

* スペースには<" ">* が入る
```


# チャンネルデータ

## チャンネルシンボル

|チャンネル名|チャンネル記号(Channel Symbol)|t|v|@|l|o|>|<|_|[|]|@v|@@|@EN|@EP|@MP|$name|
|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
|矩形波1|A|                             o|o|o|o|o|o|o|o|o|o|  o|o|o|o|o| o|
|矩形波2|B|                             o|o|o|o|o|o|o|o|o|o|  o|o|o|o|o| o|
|三角波|C|                              o|-|-|o|o|o|o|o|o|o|  -|-|o|o|o| o|
|ノイズ|D|                              o|o|o|o|-|-|-|o|o|o|  o|o|o|o|o| o|
|DPCM|E|                              o|-|-|o|-|-|-|-|o|o|  -|-|-|-|-| o|

- チャンネルシンボルは大文字限定
- "name"は任意の名前(例: $intro)

## 記述方法
```
 <Channel Symbol> <" ">+ <MML Statements>
```
### 記述例

- 一行ステートメント

```
; 以下の記述はできない
A t120 l8 @2
  c d e 
```

```
;正しくは
A t120 l8 @2
A c d e 
```

### 独立したチャンネル
- 以下の二つの記述は同じ曲データになる

```
A cde
C cde
```

```
C cd
A c
C e
A d
A e
```
### 複数チャンネル
- チャンネルシンボルは複数チャンネルまとめて記述できる

```
 ABCD t150 ; A~Dチャンネルをテンポ150にする
```



## MMLステートメント

|   |記号 |デフォルト値|範囲|説明|
|:-:|:-:|:-:|:-:|:-|
|音符|c,d,e,f,g,a,b|-|-|小文字限定(*1)(*2)|
|休符|r|-|-|小文字限定(*1)(*2)|
|シャープ & フラット|+, -|ナチュラル|-|"#"は不可|
|テンポ|t|120|30~300||
|ボリューム|v|10|0~15|| 
|トーン(音色)|@|0|矩形波=0~3, ノイズ波=0~1||
|レングス(長さ)|l|4|1~64|長さ省略時の長さ(*2)|
|オクターブ|o|4|矩形波=2~7, 三角波=1~6||
|オクターブアップ|>|-|-||
|オクターブダウン|<|-|-||
|タイ         |_|-|-|前後がノートであることが必須|
|リピート開始|[|-|-|"]"までを繰り返す|
|リピート終了|]|-|1~|指定回数だけ、直前の"["まで戻る|

|ボリュームマクロ|@v|-|n=0~|ボリュームが変更されるまで有効|
|トーンマクロ   |@@|-|n=0~|トーンが変更されるまで有効|
|アルペジオマクロ|EN|-|n=0~|ENOFまで有効|
|ピッチマクロ   |EP|-|n=0~|EPOFまで有効|
|ビブラートマクロ|MP|-|n=0~|MPOFまで有効|
|アルペジオマクロ終了|ENOF|-|-||
|ピッチマクロ終了|EPOF|-|-||
|ビブラートマクロ終了|MPOF|-|-||

|ステートメントマクロ|$name|-|-|定義済みのステートメントマクロを指定|

*1 音符や休符の長さは省略できる場合がある

*2 "c12 d12 e12"のように三連符を表現できる

### ノイズ波(Dチャンネル)の音符の扱い
- Dチャンネルは、決まった16種類(0~15)の周波数しか鳴らせない
- トーン(音色)が２種類あるので、32種類
- 値が小さいほど高い音になる

よって
  
1. オクターブは無視される
2. c~b(0~12)を15~3の音に対応させる
3. 0~2の音を出す時はアルペジオマクロを使う

何かが飛んでいく音
```
@EP0={-1}
@EP1={-2}
@EP2={-3}

D t120 l8 @0
D EP2 b EPOF EP1 b EPOF EP0 b EPOF ba+ag+gf+fed+dc+c2
```


# コメント
- ";"以降の文字はコンパイラは解釈しない
- 複数行コメントはない



;----- ここまで



# 内部フォーマット(構文解析直後)

| コマンド値    | 意味          | サイズ            | 備考 |
|:-|:-|:-|:-|
| $0_ nn ff  | 音符          | nn = ノート番号<br> ff = フレーム数(*1)  |
| $1m ff     | 休符          | m = モード(0=音止める, other=音止めない)<br> ff = フレーム数(*1)   |
| $2v        | 音量          | v = 音量値(0-15)            |
| $3t        | 音色          | t = 音色: 矩形波(0-3)<br> ノイズ(0-1) |
| $4l [pp]   | ピッチ        | l = 長さ:0=ピッチリセット, other=ピッチ変量更新(pp => -128~127) |
| $5o        | オクターブ     | o = オクターブ値(0-5 => o2-o7)
| $6_        | オクターブUP   | 引数なし|
| $7_        | オクターブDOWN | 引数なし|
| $80(*4)| ボリュームマクロ | マクロ番号 | (*2) |
| $81        | 音色マクロ     | マクロ番号 | (*2) |
| $82        | アルペジオマクロ開始 | マクロ番号 | (*2) |
| $83        | ピッチマクロ    | マクロ番号 | (*2) |
| $84        | ビブラートマクロ開始 | マクロ番号 | (*2) |
| $8C        | アルペジオマクロ終了 | なし | |
| $8D        | ピッチマクロ終了 | なし | |
| $8E        | ビブラートマクロ終了 | なし |
| $A_        | リピート開始    | なし(リピートカウントに$FFを設定)|
| $Br        | リピート終了    | r = リピート回数(0-15)   |
| $C_ aa aa  | コール       | aaaa = 戻る絶対アドレス($0000~$FFFF リトルエンディアン)|
| $FF        | 終端子        | 引数なし               |

```
廃止
| $80<br>(無くなるかも)| ボリュームマクロ | マクロ番号 | (*2) |
| $81        | 音色マクロ     | マクロ番号 | (*2) |
| $82        | アルペジオマクロ開始 | マクロ番号 | (*2) |
| $83        | ピッチマクロ    | マクロ番号 | (*2) |
| $84        | ビブラートマクロ開始 | マクロ番号 | (*2) |
| $92        | アルペジオマクロ終了 | なし | |
| $93        | ピッチマクロ終了 | なし | |
| $94        | ビブラートマクロ終了 | なし |
```

*1 省略時は "-1" が入る

*2 バイナリ変換時に番号は振り直すのでmmlの番号とは一致しない

*3 ピッチ量は通常0

*4 $D0~$DFは


## マクロ値の共有エンコード
|ビット|範囲|説明|
|:-:|:-:|:-|
|1000-0000|-128|ループバックシンボル<br>(次の1バイトが戻る値)|
|1000-0001<br>0111-1110|-127 ~ 126|数値|
|0111-1111|127|未使用|







# 音階・周波数計算

- 音階n: C1=0 - A8=93

```
 a4の周波数 = 440
 周波数f: = 440 x 2 xx (n / 12)
```

- 算出式

```
 f = fn(note, octave)
   = 440 * 2 ** (( (note-9) + (octave-4) * 12 -  )/12)
タイマー値T: = -1 + 1789773 / 16 / f
```

# 長さ(音符, 休符)

- 定義
```
 テンポ t (例 = 160)
 符長 len (例 = 32 = 32分音符)

 * 符長: 音符や休符の長さ
```

- 定数A
```
 A = 60fps x 60秒 x 4分音符 = 14400
```

- 符長のフレーム数 F
```
 F =  Int (A / t / len)

 * Int()で切り捨てられた少数点以下の値は累積され、
   "1"を超えると音符や休符を1フレーム長くして調整している
```


### タイマー値の計算
f = clock / (16 *(timer + 1))
timer = clock / (16 x f) - 1

# 補足・未整理メモ

```
 <Macro> ::= "@" <MacroName> <M_Number> "=" "{" <NumberList> "}"

 <NumberList> ::= <Number>+                -- ループなし
               |  <Number>+ "|" <Number>+  -- ループあり
               |  "|" <Number>+            -- 冒頭からループ
               |  <Delay> <Speed> <Depth>  -- ビブラートのとき

 <MacroName> ::= "v" | "@" | "en" | "ep" | "mp"

 <M_Number>  ::= 0-127
              |  0-63           -- ビブラートのとき

 <Number>    ::=    0 ~ 15      -- ボリューム
              |     0 ~ 3       -- 音色
              |  -127 ~ 126     -- アルペジオ
              |  -127 ~ 126     -- ピッチ

 <Delay> ::= 0 ~ 255
 <Speed> ::= 1 ~ 255
 <Depth> ::= 0 ~ 255

```


# システム負荷・制約

## CPU負荷
```
 VBlink : 20 x 341 = 6820[cyc]
 OAM転送 : 512[cyc]

 サウンドドライバ: 820 + 55 x 2 [cyc]
```
## データサイズ例
```
曲のデータサイズ: 159[byte](The Theme of lilca)
```



###d 未整理メモf
ノイズチャンネル
@v1={12 15 14 14 13 13 | 8 8 8 8 3 3 3 3 0 }
; 音階 c - b  0-4 5 6 7 8 9 a b c d e f
;$400E b3-0 = 0  1 2 3 4 5 6 7 8 9 a b
音階	c	d	e	f	g	a	b
周期	5	6	7	8	9	a	b
0-4,c-fが使えない

# 参考文献

[Ultimate PPMCK MML Reference](https://woolyss.com/chipmusic/chipmusic-mml/ppmck_guide.php)

[MCK/MML BEGINNERS GUIDE](https://www.nesdev.org/mck_guide_v1.0.txt)
