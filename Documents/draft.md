# lilcaSoundDriverFC 仕様書

## 基礎知識

### 音符や休符の長さ計算

- 定義
```
 テンポ t (例 = 160)
 符長 len (例 = 32 = 32分音符)

 * 符長: 音符や休符の長さ
```

- 定数A
```
 A = 60fps x 60秒 x 4分音符 = 14400
```

- 符長のフレーム数 F
```
 F =  Int (A / t / len)

 * Int()で切り捨てられた少数点以下の値は累積され、
   "1"を超えると音符や休符を1フレーム長くして調整している
```

## ステートメント

### メタ

#### 変換されたコードのコメントとして出力されます

|項目|キーワード|備考|
|:-:|:-:|:-|
|曲名|;#TITLE||
|作曲者|;#COMPOSER||
|ラベル|;#LABEL|コード上のラベル名|

#### いずれのメタ情報もキーワード直後の区切り文字以降の文字列を前後トリミングして値とする

```
";#COMPOSER   lilca reload   "

Meta Value = "lilca reload"
```

### マクロ
- 一覧

|マクロ名|定義|使用|終端子|
|:-|:-:|:-:|:-:|
|ボリューム|@v[n]|@v[n]|-|
|音色|@[n]|@@[n]|-|
|アルペジオ|@en[n]|en[n]|  enof|
|ピッチ|@ep[n]|ep0| epof|
|ビブラート|@mp[n]|mp[n]|  mpof

#### n はいずれも 0 - 127

- 定義

```
 <Macro> ::= "@" <MacroName> <M_Number> "=" "{" <NumberList> "}"

 <NumberList> ::= <Number>+                -- ループなし
               |  <Number>+ "|" <Number>+  -- ループあり
               |  "|" <Number>+            -- 冒頭からループ
               |  <Delay> <Speed> <Depth>  -- ビブラートのとき

 <MacroName> ::= "v" | "@" | "en" | "ep" | "mp"

 <M_Number>  ::= 0-127
              |  0-63           -- ビブラートのとき

 <Number>    ::=    0 ~ 15      -- ボリューム
              |     0 ~ 3       -- 音色
              |  -127 ~ 126     -- アルペジオ
              |  -127 ~ 126     -- ピッチ

 <Delay> ::= 0 ~ 255
 <Speed> ::= 1 ~ 255
 <Depth> ::= 0 ~ 255

```

### チャンネル
- 矩形波チャンネル1
- 矩形波チャンネル2
- 三角波チャンネル
- ノイズチャンネル
- DPCMチャンネル


## 命令コード

| コマンド値    | 意味          | サイズ            | 備考 |
|:-:|:-|:-|:-|
| $00        | 音符          | ノート番号, フレーム数  |
| $01        | 休符          | フレーム数   |
| $02        | 音量          | 音量値(0-15)            |
| $03        | 音色          | 矩形波(0-3), ノイズ(0-1) |
| $04        | Reserved     | 未使用 |
| $05        | オクターブ     | オクターブ値(0-5 => o2-o7)
| $06        | オクターブUP   | 引数なし
| $07        | オクターブDOWN | 引数なし
| $0A        | スウィープ     | スウィープ値|EPPP NSSS<br>E=有効<br>PPP=ピリオド<br>N=反転<br>SSS=シフト|
| $10        | リピート開始    | なし(カウントに$FFを設定)
| $11        | リピート終了    | リピート回数(0-127)   |
| $80<br>(無くなるかも)| ボリュームマクロ | マクロ番号 | バイナリ変換時に番号は振り直すのでmmlの番号とは違うこともある) |
| $FF        | 終端子        | 引数なし               |

## 音階

音階n: C1=0 - A8=93
a4の周波数 = 440
周波数f: = 440 x 2 xx (n / 12)
f = fn(note, octave)
  = 440 * 2 ** (( (note-9) + (octave-4) * 12 -  )/12)
タイマー値T: = -1 + 1789773 / 16 / f

## 長さ(音符, 休符)



## デフォルト値

|項目|デフォルト値|
|:-|:-:|
|テンポ|120|
|長さ|4|
|ボリューム|12|
|オクターブ|4|


#### タイマー値の計算
f = clock / (16 *(timer + 1))
timer = clock / (16 x f) - 1

#### 未整理メモ
ノイズチャンネル
@v1={12 15 14 14 13 13 | 8 8 8 8 3 3 3 3 0 }
; 音階 c - b  0-4 5 6 7 8 9 a b c d e f
;$400E b3-0 = 0  1 2 3 4 5 6 7 8 9 a b
音階	c	d	e	f	g	a	b
周期	5	6	7	8	9	a	b
0-4,c-fが使えない
