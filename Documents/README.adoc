= lilcaSoundDriverFC 仕様書

:toc:

== 負荷

----
VBlink : 20 x 341 = 6820[cyc]
OAM転送 : 512[cyc]

サウンドドライバ: 820 + 55 x 2 [cyc]
曲のデータサイズ: 159[byte](The Theme of lilca)
----

== メタ情報

=== 変換されたコードのコメントとして出力されます

* 書式
[source,mml]
----
#<META_NAME> <string>
----

* FC側で使う可能性のあるメタ情報

|===
|項目 |キーワード |備考

|曲名 |#TITLE |
|作曲者 |#COMPOSER |
|プログラマ |#PROGRAMER |MMLやサウンドデータに起こした人
|ラベル |#LABEL |プログラム上で使われるラベル名(*1)
|===

(*1 mck mmlの仕様にない)

=== いずれのメタ情報もキーワード直後の区切り文字以降の文字列を前後トリミングして値とする

[source,mml]
----
例:
 "#COMPOSER   lilca reload   "

 Meta Value = "lilca reload"
----

== マクロ

=== 一覧

|===
|マクロ名 |定義 |使用 |ループ指定 |終端子 |有効チャンネル |備考

|ボリューム |@v[n] |@v[n] |あり(*2) |-|12N (*1) |フレーム単位でボリュームを変化させる
|音色 |@[n] |@@[n] |あり(*2) |-|12N (*1) |フレーム単位で音色を変化させる
|アルペジオ(*3) |@EN[n] |EN[n] |あり(*2) |ENOF |12TN (*1) |フレーム単位で音階を変化させる
|ピッチ(*3) |@EP[n] |EP0 |あり(*2) |EPOF |12TN (*1) |指定方向と量で音階を変化させる
|ビブラート(*3) |@MP[n] |MP[n] |-|MPOF |12TN (*1) |Sin波で音階を変化させる
|DPCM割り当て(*3) |@DPCM[n] |音階 |- |- |D (*1) |n=0,1,2... → c,c+,d... に割り当て
|===

*1 チャンネル名: 1=矩形波1, 2=矩形波2, T=三角波, N=ノイズ波, D=DPCM  
*2 "|"以降をループする  
*3 未対応  

== マクロパラメータ値

=== マクロ値

|===
|ビット |範囲 |説明

|1000-0000 |-128 |ループバックシンボル（次の1バイトが戻る値）
|1000-0001〜0111-1110 |-127〜126 |マクロ値
|0111-1111 |127 |未使用
|===

=== ボリューム, 音色, アルペジオ, ピッチ 共通

|===
|値 |範囲 |説明

|ボリューム値 |0〜15 |
|音色 |0〜3 |矩形波=duty比 / ノイズ=モード
|相対音階 |-127〜126 |c に対して ±1
|増減値 |-127〜126 |矩形/三角=11bitタイマー, ノイズ=4bit
|===

[source,mml]
----
@v0={ 15 8 4 2 0 }
@v1={ 15 |8 4 }
@v2={ |15 15 12 11 10 8 8 8 }
@ep0={2 |4 0}
@ep1={-16}
----

=== ビブラート

|===
|値 |範囲 |説明

|遅延 |0〜255 |Sin開始までのフレーム数
|速さ |1〜255 |Sin周期
|深さ |0〜255 |Sin振幅
|===

[source,mml]
----
@mp={4 8 6}
----

=== DPCM

|===
|値 |範囲 |説明

|ファイルパス |文字列 |実行ディレクトリからの相対パス
|パラメータ1 |0〜15 |ピッチ（Rate Index）
|パラメータ2 |0〜4081 |再生ブロック数(16byte単位)
|パラメータ3 |0〜15 |出力レベル（$FF 推奨）
|パラメータ4 |0〜2 |再生モード（0=1ショット）
|===

=== (著者用のメモ)

[source,mml]
----
<Macro> ::= "@" <MacroName> <M_Number> "=" "{" <NumberList> "}"
...
----

== チャンネル

|===
|チャンネル名 |シンボル
|矩形波1 |A
|矩形波2 |B
|三角波 |C
|ノイズ |D
|DPCM |E
|===

== 内部フォーマット (構文解析のみ)

|===
|コマンド値 |意味 |サイズ |備考

|$0_ nn ff |音符 |nn=音階, ff=長さ |
|$1m ff |休符 |m=モード, ff=長さ |
|$2v |音量 |v=0〜15 |
|$3t |音色 |t=0〜3 |
|$4_ pp pp |ピッチ |pppp=±32768 |
|$5o |オクターブ |o=0〜5 |
|$6_ |オクターブUP |
|$7_ |オクターブDOWN |
|$80 |ボリュームマクロ |番号 |
|$81 |音色マクロ |番号 |
|$82 |アルペジオ開始 |番号 |
|$83 |ピッチマクロ |番号 |
|$84 |ビブラート開始 |番号 |
|$8C |アルペジオ終了 |
|$8D |ピッチ終了 |
|$8E |ビブラート終了 |
|$A_ |リピート開始 |
|$Br |リピート終了 |r=回数 |
|$FF |終端 |
|===

== 音階

C1=0 - A8=93

----
f = 440 * 2 ** (n/12)
----

== 長さ (音符/休符)

----
テンポ t
符長 len
----

----
F = Int(14400 / t / len)
----

== デフォルト値

|===
|項目 |デフォルト
|テンポ |120
|長さ |4
|ボリューム |12
|オクターブ |4
|===

== 参考文献

* https://woolyss.com/chipmusic/chipmusic-mml/ppmck_guide.php[Ultimate PPMCK MML Reference]
* https://www.nesdev.org/mck_guide_v1.0.txt[MCK/MML BEGINNERS GUIDE]
